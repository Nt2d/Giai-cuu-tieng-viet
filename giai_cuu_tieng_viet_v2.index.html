<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ†˜ Giáº£i cá»©u tiáº¿ng Viá»‡t â€” Game chÃ­nh táº£</title>
  <style>
    :root{
      --bg1:#F3F7EE; --bg2:#FFFFFF;
      --emerald:#059669; --emerald-50:#ecfdf5;
      --rose:#ef4444; --slate:#334155; --muted:#64748b;
      --border:#cce3d5; --card:#ffffff;
    }
    html,body{margin:0;height:100%;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--slate);}
    body{background:linear-gradient(180deg,var(--bg1),var(--bg2) 40%, var(--bg1));}
    .container{max-width:1050px;margin:0 auto;padding:16px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:24px;box-shadow:0 10px 30px rgba(31,112,67,.08);padding:20px;}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
    .pill{border:1px solid #bfe3d0;background:#f0fff4;border-radius:999px;padding:4px 10px;font-size:14px}
    .btn{border:0;border-radius:12px;padding:10px 14px;font-weight:800;cursor:pointer}
    .btn-emerald{background:var(--emerald);color:white}
    .btn-emerald-ghost{background:var(--emerald-50);border:1px solid #a7f3d0;color:#065f46}
    .btn-gray{background:#e5e7eb;color:#111827}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){.grid-4{grid-template-columns:repeat(4,1fr)}}
    .station{opacity:1; transition:opacity .2s; padding:16px;border:1px solid #bee3cd;background:#f0fff9;border-radius:18px}
    .station.disabled{opacity:0.45; pointer-events:none;}
    .hide{display:none}
    .hint{font-size:12px;color:var(--muted)}
    .title{font-size:20px;font-weight:900;color:#065f46}
    .subtitle{font-size:12px;color:#0f766e}
    .big{font-size:22px;font-weight:900;color:#0f172a;line-height:1.25}
    .win{background:#ecfeff;border-color:#a5f3fc}
    .lose{background:#fff1f2;border-color:#fecdd3}
    .divider{height:1px;background:#e2e8f0;margin:14px 0;border-radius:999px}
    input[type="text"]{width:100%;border-radius:14px;border:1px solid #cbd5e1;padding:10px;font-size:16px}
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="row" style="margin-bottom:8px">
      <div>
        <div style="font-size:24px;font-weight:900;color:#065f46" id="appTitle">ğŸ†˜ Giáº£i cá»©u tiáº¿ng Viá»‡t</div>
        <div class="subtitle" id="appSubtitle">4 tráº¡m: Ã‚m chuáº©n â€¢ Tá»« Ä‘Ãºng â€¢ HÃ¡ch nÃ£o â€¢ ThÃ´ng thÃ¡i</div>
      </div>

      <div class="row" style="gap:8px">
        <div class="pill">Äiá»ƒm: <b id="score">0</b></div>
        <div class="pill">Huy hiá»‡u: <b id="badgesCount">0</b></div>

        <div class="row" style="gap:6px">
          <span class="hint">Giá»ng:</span>
          <button class="btn btn-emerald-ghost" id="maleBtn">Nam</button>
          <button class="btn btn-emerald-ghost" id="femaleBtn">Ná»¯</button>
          <button class="btn btn-emerald-ghost" id="tryVoiceBtn">ğŸ”Š Thá»­ tiáº¿ng</button>
        </div>

        <button class="btn btn-emerald" id="homeBtn" disabled>ğŸ  Trang chÃ­nh</button>
        <button class="btn btn-gray" id="resetBtn" title="XÃ³a tiáº¿n Ä‘á»™ trÃªn mÃ¡y nÃ y">Reset</button>
      </div>
    </div>

    <div class="divider"></div>

    <div id="screenMap">
      <p class="hint">Chá»n tráº¡m Ä‘á»ƒ báº¯t Ä‘áº§u. HoÃ n thÃ nh tráº¡m sáº½ má»Ÿ khÃ³a tráº¡m káº¿ tiáº¿p.</p>
      <div class="grid grid-4" id="mapStations"></div>
    </div>

    <div id="screenStation" class="hide">
      <div class="title" id="stationTitle">Tráº¡m</div>
      <div class="station" id="stationCard"></div>
    </div>

    <div class="hint" style="margin-top:10px">Tráº¡ng thÃ¡i Ã¢m thanh: <span id="ttsState">Sáºµn sÃ ng</span></div>
  </div>
</div>

<script>
const CONFIG = {
  title: "ğŸ†˜ Giáº£i cá»©u tiáº¿ng Viá»‡t",
  subtitle: "4 tráº¡m: Ã‚m chuáº©n â€¢ Tá»« Ä‘Ãºng â€¢ HÃ¡ch nÃ£o â€¢ ThÃ´ng thÃ¡i",
  lang: "vi-VN",
  stations: [
    { id:"amchuan",  icon:"ğŸ§", name:"Ã‚m chuáº©n",  desc:"Chá»n tá»« Ä‘Ãºng chÃ­nh táº£",              type:"mcq",  rounds:30 },
    { id:"tudung",   icon:"âœ…", name:"Tá»« hay",   desc:"Chá»n tá»« Ä‘Ãºng trong cÃ¢u",            type:"mcq",  rounds:30 },
    { id:"hachnao",  icon:"ğŸ§ ", name:"HÃ¡ch nÃ£o",  desc:"Giá»¯ nguyÃªn bá»™ cÃ¢u há»i tráº¡m 3",      type:"mcq",  rounds:30 },
    { id:"thongthai",icon:"ğŸ“", name:"ThÃ´ng thÃ¡i",desc:"Äiá»n tá»« Ä‘Ãºng chÃ­nh táº£ (gÃµ Ä‘Ã¡p Ã¡n)", type:"fill", rounds:30 },
  ],
  banks: {
    amchuan: [{"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["LÃ m", "NÃ m"], "correct": "LÃ m"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["LÃºa", "NÃºa"], "correct": "LÃºa"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["ChÃ¢n", "TrÃ¢n"], "correct": "ChÃ¢n"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Dá»¯", "Giá»¯", "rá»¯"], "correct": "Giá»¯"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["RÆ¡m", "giÆ¡m", "dÆ¡m"], "correct": "RÆ¡m"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Rá»§", "giá»§", "dá»§"], "correct": "Rá»§"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["TrÃªu", "chÃªu"], "correct": "TrÃªu"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["TrÃ²n", "chÃ²n"], "correct": "TrÃ²n"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Chá»", "trá»"], "correct": "Chá»"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["ChÃ¹a", "trÃ¹a"], "correct": "ChÃ¹a"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["TruyÃªn", "chuyÃªn"], "correct": "chuyÃªn"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Sáº·c", "xáº·c"], "correct": "Sáº·c"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Sáº¯n", "xáº¯n"], "correct": "Sáº¯n"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Sáº¥y", "xáº¥y"], "correct": "Sáº¥y"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["XÃ­ch", "sÃ­ch"], "correct": "XÃ­ch"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Ná»•", "lá»•"], "correct": "Ná»•"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Ná»•i", "lá»•i"], "correct": "Ná»•i"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Lá»£n", "ná»£n"], "correct": "Lá»£n"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Lá»¥t", "ná»¥t"], "correct": "Lá»¥t"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["LÆ°á»¡i", "nÆ°á»¡i"], "correct": "LÆ°á»¡i"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Ná»©t", "lá»©t"], "correct": "Ná»©t"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Sáº·c", "xáº·c"], "correct": "Sáº·c"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["LÃ m", "NÃ m"], "correct": "LÃ m"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["LÃºa", "NÃºa"], "correct": "LÃºa"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["ChÃ¢n", "TrÃ¢n"], "correct": "ChÃ¢n"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Dá»¯", "Giá»¯", "rá»¯"], "correct": "Giá»¯"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["RÆ¡m", "giÆ¡m", "dÆ¡m"], "correct": "RÆ¡m"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["Rá»§", "giá»§", "dá»§"], "correct": "Rá»§"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["TrÃªu", "chÃªu"], "correct": "TrÃªu"}, {"q": "Chá»n tá»« Ä‘Ãºng:", "choices": ["TrÃ²n", "chÃ²n"], "correct": "TrÃ²n"}],
    tudung: [{"q": "Tiáº¿ng chim hÃ³t â€¦â€¦â€¦ buá»•i sÃ¡ng.", "choices": ["lÃ­u lo", "nÃ­u no", "lÃ­u no", "nÃ­u lo"], "correct": "lÃ­u lo"}, {"q": "Trá»i mÆ°a to lÃ m con Ä‘Æ°á»ng trá»Ÿ nÃªn â€¦â€¦â€¦", "choices": ["trÆ¡n trÆ°á»£t", "trÆ¡n truá»™t", "chÆ¡n trÆ°á»£t", "chÆ¡n truá»™t"], "correct": "trÆ¡n trÆ°á»£t"}, {"q": "Tiáº¿ng chim hÃ³t â€¦â€¦â€¦ buá»•i sÃ¡ng.", "choices": ["lÃ­u lo", "nÃ­u no", "lÃ­u no", "nÃ­u lo"], "correct": "lÃ­u lo"}, {"q": "CÃ´ giÃ¡o giáº£ng bÃ i ráº¥t â€¦â€¦â€¦", "choices": ["rÃµ rÃ ng", "rÃµ dÃ ng", "dÃµ rÃ ng", "dÃµ dÃ ng"], "correct": "rÃµ rÃ ng"}, {"q": "CÆ¡n giÃ³ nháº¹ lÃ m lÃ¡ cÃ¢y â€¦â€¦â€¦", "choices": ["xÃ o xáº¡c", "sao sáº¡c", "xao xáº¡c", "xÃ o sáº¡c"], "correct": "xÃ o xáº¡c"}, {"q": "ChÃºng ta cáº§n giá»¯ gÃ¬n mÃ´i trÆ°á»ng â€¦â€¦â€¦", "choices": ["sáº¡ch sáº½", "sáº¡ch sáº»", "sáº·c sáº½", "sáº¡ch xáº½"], "correct": "sáº¡ch sáº½"}, {"q": "Báº¡n Nam cÃ³ giá»ng Ä‘á»c ráº¥t â€¦â€¦â€¦", "choices": ["truyá»n cáº£m", "chuyá»n cáº£m", "truyá»n cÃ£m", "chuyá»n cÃ£m"], "correct": "truyá»n cáº£m"}, {"q": "Nhá»¯ng bÃ´ng hoa khoe sáº¯c â€¦â€¦â€¦", "choices": ["rá»±c rá»¡", "rá»±c rá»¡", "rá»±c dá»¡", "rá»±c rá»Ÿ"], "correct": "rá»±c rá»¡"}, {"q": "Em luÃ´n â€¦â€¦â€¦ lá»i há»©a cá»§a mÃ¬nh.", "choices": ["giá»¯", "dá»­", "dá»¯", "dá»±"], "correct": "giá»¯"}, {"q": "Con Ä‘Æ°á»ng lÃ ng quanh co, â€¦â€¦â€¦", "choices": ["khÃºc khuá»·u", "khÃºc khá»§y", "khÃºc khuá»·", "khÃºc khá»‰u"], "correct": "khÃºc khuá»·u"}, {"q": "Em bÃ© ngá»§ ráº¥t â€¦â€¦â€¦", "choices": ["say sÆ°a", "say xÆ°a", "sai sÆ°a", "say sua"], "correct": "say sÆ°a"}, {"q": "ChÃº bá»™ Ä‘á»™i Ä‘á»©ng gÃ¡c ráº¥t â€¦â€¦â€¦", "choices": ["nghiÃªm trang", "nghiÃªm trÄƒng", "nghiÃªm chÄƒng", "nghiÃªm chang"], "correct": "nghiÃªm trang"}, {"q": "Em bÃ© cÃ³ Ä‘Ã´i máº¯t ráº¥t â€¦â€¦â€¦", "choices": ["long lanh", "nong nanh", "long nanh", "nong lanh"], "correct": "long lanh"}, {"q": "Tiáº¿ng trá»‘ng trÆ°á»ng vang lÃªn â€¦â€¦â€¦", "choices": ["rá»™n rÃ ng", "dá»™n dÃ ng", "rá»™n dÃ ng", "dá»™n rÃ ng"], "correct": "rá»™n rÃ ng"}, {"q": "Tiáº¿ng chim hÃ³t â€¦â€¦â€¦ buá»•i sÃ¡ng.", "choices": ["lÃ­u lo", "nÃ­u no", "lÃ­u no", "nÃ­u lo"], "correct": "lÃ­u lo"}, {"q": "Trá»i mÆ°a to lÃ m con Ä‘Æ°á»ng trá»Ÿ nÃªn â€¦â€¦â€¦", "choices": ["trÆ¡n trÆ°á»£t", "trÆ¡n truá»™t", "chÆ¡n trÆ°á»£t", "chÆ¡n truá»™t"], "correct": "trÆ¡n trÆ°á»£t"}, {"q": "Tiáº¿ng chim hÃ³t â€¦â€¦â€¦ buá»•i sÃ¡ng.", "choices": ["lÃ­u lo", "nÃ­u no", "lÃ­u no", "nÃ­u lo"], "correct": "lÃ­u lo"}, {"q": "CÃ´ giÃ¡o giáº£ng bÃ i ráº¥t â€¦â€¦â€¦", "choices": ["rÃµ rÃ ng", "rÃµ dÃ ng", "dÃµ rÃ ng", "dÃµ dÃ ng"], "correct": "rÃµ rÃ ng"}, {"q": "CÆ¡n giÃ³ nháº¹ lÃ m lÃ¡ cÃ¢y â€¦â€¦â€¦", "choices": ["xÃ o xáº¡c", "sao sáº¡c", "xao xáº¡c", "xÃ o sáº¡c"], "correct": "xÃ o xáº¡c"}, {"q": "ChÃºng ta cáº§n giá»¯ gÃ¬n mÃ´i trÆ°á»ng â€¦â€¦â€¦", "choices": ["sáº¡ch sáº½", "sáº¡ch sáº»", "sáº·c sáº½", "sáº¡ch xáº½"], "correct": "sáº¡ch sáº½"}, {"q": "Báº¡n Nam cÃ³ giá»ng Ä‘á»c ráº¥t â€¦â€¦â€¦", "choices": ["truyá»n cáº£m", "chuyá»n cáº£m", "truyá»n cÃ£m", "chuyá»n cÃ£m"], "correct": "truyá»n cáº£m"}, {"q": "Nhá»¯ng bÃ´ng hoa khoe sáº¯c â€¦â€¦â€¦", "choices": ["rá»±c rá»¡", "rá»±c rá»¡", "rá»±c dá»¡", "rá»±c rá»Ÿ"], "correct": "rá»±c rá»¡"}, {"q": "Em luÃ´n â€¦â€¦â€¦ lá»i há»©a cá»§a mÃ¬nh.", "choices": ["giá»¯", "dá»­", "dá»¯", "dá»±"], "correct": "giá»¯"}, {"q": "Con Ä‘Æ°á»ng lÃ ng quanh co, â€¦â€¦â€¦", "choices": ["khÃºc khuá»·u", "khÃºc khá»§y", "khÃºc khuá»·", "khÃºc khá»‰u"], "correct": "khÃºc khuá»·u"}, {"q": "Em bÃ© ngá»§ ráº¥t â€¦â€¦â€¦", "choices": ["say sÆ°a", "say xÆ°a", "sai sÆ°a", "say sua"], "correct": "say sÆ°a"}, {"q": "ChÃº bá»™ Ä‘á»™i Ä‘á»©ng gÃ¡c ráº¥t â€¦â€¦â€¦", "choices": ["nghiÃªm trang", "nghiÃªm trÄƒng", "nghiÃªm chÄƒng", "nghiÃªm chang"], "correct": "nghiÃªm trang"}, {"q": "Em bÃ© cÃ³ Ä‘Ã´i máº¯t ráº¥t â€¦â€¦â€¦", "choices": ["long lanh", "nong nanh", "long nanh", "nong lanh"], "correct": "long lanh"}, {"q": "Tiáº¿ng trá»‘ng trÆ°á»ng vang lÃªn â€¦â€¦â€¦", "choices": ["rá»™n rÃ ng", "dá»™n dÃ ng", "rá»™n dÃ ng", "dá»™n rÃ ng"], "correct": "rá»™n rÃ ng"}, {"q": "Tiáº¿ng chim hÃ³t â€¦â€¦â€¦ buá»•i sÃ¡ng.", "choices": ["lÃ­u lo", "nÃ­u no", "lÃ­u no", "nÃ­u lo"], "correct": "lÃ­u lo"}, {"q": "Trá»i mÆ°a to lÃ m con Ä‘Æ°á»ng trá»Ÿ nÃªn â€¦â€¦â€¦", "choices": ["trÆ¡n trÆ°á»£t", "trÆ¡n truá»™t", "chÆ¡n trÆ°á»£t", "chÆ¡n truá»™t"], "correct": "trÆ¡n trÆ°á»£t"}],
    // Tráº¡m 3 giá»¯ nguyÃªn bá»™ cÃ¢u há»i (láº¥y tá»« báº£n game trÆ°á»›c)
    hachnao: [{"q": "Máº¹ dáº·n mua ... gáº¡o.", "choices": ["lÃ²", "nÃ²", "lá»", "no"], "correct": "lá»"}, {"q": "Báº¡n áº¥y ...i xe ráº¥t giá»i.", "choices": ["láº£", "lÃ¡i", "nÃ¡i", "náº£i"], "correct": "lÃ¡i"}, {"q": "Trá»i ... nÃ³ng.", "choices": ["náº¯ng", "láº¯ng"], "correct": "náº¯ng"}, {"q": "Máº¹ dáº·n mua ... gáº¡o.", "choices": ["lÃ²", "nÃ²", "lá»", "no"], "correct": "lá»"}, {"q": "Báº¡n áº¥y ...i xe ráº¥t giá»i.", "choices": ["láº£", "lÃ¡i", "nÃ¡i", "náº£i"], "correct": "lÃ¡i"}, {"q": "Trá»i ... nÃ³ng.", "choices": ["náº¯ng", "láº¯ng"], "correct": "náº¯ng"}, {"q": "Máº¹ dáº·n mua ... gáº¡o.", "choices": ["lÃ²", "nÃ²", "lá»", "no"], "correct": "lá»"}, {"q": "Báº¡n áº¥y ...i xe ráº¥t giá»i.", "choices": ["láº£", "lÃ¡i", "nÃ¡i", "náº£i"], "correct": "lÃ¡i"}, {"q": "Trá»i ... nÃ³ng.", "choices": ["náº¯ng", "láº¯ng"], "correct": "náº¯ng"}, {"q": "Máº¹ dáº·n mua ... gáº¡o.", "choices": ["lÃ²", "nÃ²", "lá»", "no"], "correct": "lá»"}, {"q": "Báº¡n áº¥y ...i xe ráº¥t giá»i.", "choices": ["láº£", "lÃ¡i", "nÃ¡i", "náº£i"], "correct": "lÃ¡i"}, {"q": "Trá»i ... nÃ³ng.", "choices": ["náº¯ng", "láº¯ng"], "correct": "náº¯ng"}, {"q": "Máº¹ dáº·n mua ... gáº¡o.", "choices": ["lÃ²", "nÃ²", "lá»", "no"], "correct": "lá»"}, {"q": "Báº¡n áº¥y ...i xe ráº¥t giá»i.", "choices": ["láº£", "lÃ¡i", "nÃ¡i", "náº£i"], "correct": "lÃ¡i"}, {"q": "Trá»i ... nÃ³ng.", "choices": ["náº¯ng", "láº¯ng"], "correct": "náº¯ng"}, {"q": "Máº¹ dáº·n mua ... gáº¡o.", "choices": ["lÃ²", "nÃ²", "lá»", "no"], "correct": "lá»"}, {"q": "Báº¡n áº¥y ...i xe ráº¥t giá»i.", "choices": ["láº£", "lÃ¡i", "nÃ¡i", "náº£i"], "correct": "lÃ¡i"}, {"q": "Trá»i ... nÃ³ng.", "choices": ["náº¯ng", "láº¯ng"], "correct": "náº¯ng"}, {"q": "Máº¹ dáº·n mua ... gáº¡o.", "choices": ["lÃ²", "nÃ²", "lá»", "no"], "correct": "lá»"}, {"q": "Báº¡n áº¥y ...i xe ráº¥t giá»i.", "choices": ["láº£", "lÃ¡i", "nÃ¡i", "náº£i"], "correct": "lÃ¡i"}, {"q": "Trá»i ... nÃ³ng.", "choices": ["náº¯ng", "láº¯ng"], "correct": "náº¯ng"}, {"q": "Máº¹ dáº·n mua ... gáº¡o.", "choices": ["lÃ²", "nÃ²", "lá»", "no"], "correct": "lá»"}, {"q": "Báº¡n áº¥y ...i xe ráº¥t giá»i.", "choices": ["láº£", "lÃ¡i", "nÃ¡i", "náº£i"], "correct": "lÃ¡i"}, {"q": "Trá»i ... nÃ³ng.", "choices": ["náº¯ng", "láº¯ng"], "correct": "náº¯ng"}, {"q": "Máº¹ dáº·n mua ... gáº¡o.", "choices": ["lÃ²", "nÃ²", "lá»", "no"], "correct": "lá»"}, {"q": "Báº¡n áº¥y ...i xe ráº¥t giá»i.", "choices": ["láº£", "lÃ¡i", "nÃ¡i", "náº£i"], "correct": "lÃ¡i"}, {"q": "Trá»i ... nÃ³ng.", "choices": ["náº¯ng", "láº¯ng"], "correct": "náº¯ng"}, {"q": "Máº¹ dáº·n mua ... gáº¡o.", "choices": ["lÃ²", "nÃ²", "lá»", "no"], "correct": "lá»"}, {"q": "Báº¡n áº¥y ...i xe ráº¥t giá»i.", "choices": ["láº£", "lÃ¡i", "nÃ¡i", "náº£i"], "correct": "lÃ¡i"}, {"q": "Trá»i ... nÃ³ng.", "choices": ["náº¯ng", "láº¯ng"], "correct": "náº¯ng"}],
    thongthai: [{"q": "Tuá»•i tráº» cáº§n xÃ¡c Ä‘á»‹nh rÃµ ___ sá»‘ng Ä‘á»ƒ Ä‘á»‹nh hÆ°á»›ng tÆ°Æ¡ng lai.", "answers": ["lÃ½ tÆ°á»Ÿng"]}, {"q": "Viá»‡c há»c táº­p suá»‘t Ä‘á»i lÃ  má»™t yÃªu cáº§u ___ yáº¿u cá»§a xÃ£ há»™i hiá»‡n Ä‘áº¡i.", "answers": ["táº¥t", "táº¥t yáº¿u"]}, {"q": "Má»—i há»c sinh cáº§n cÃ³ Ã½ thá»©c ___ nhiá»‡m vá»›i báº£n thÃ¢n vÃ  cá»™ng Ä‘á»“ng.", "answers": ["trÃ¡ch", "trÃ¡ch nhiá»‡m"]}, {"q": "ThÃ nh cÃ´ng khÃ´ng Ä‘áº¿n tá»« may máº¯n mÃ  tá»« sá»± ___ bá»n bá»‰.", "answers": ["ná»— lá»±c"]}, {"q": "LÃ²ng ___ Ã¡i lÃ  ná»n táº£ng cá»§a Ä‘áº¡o Ä‘á»©c con ngÆ°á»i.", "answers": ["nhÃ¢n", "nhÃ¢n Ã¡i"]}, {"q": "Giao tiáº¿p hiá»‡u quáº£ giÃºp con ngÆ°á»i dá»… dÃ ng ___ láº­p cÃ¡c má»‘i quan há»‡.", "answers": ["thiáº¿t", "thiáº¿t láº­p"]}, {"q": "NhÃ  trÆ°á»ng cÃ³ vai trÃ² quan trá»ng trong viá»‡c hÃ¬nh thÃ nh ___ cÃ¡ch há»c sinh.", "answers": ["nhÃ¢n", "nhÃ¢n cÃ¡ch"]}, {"q": "Sá»± trung thá»±c lÃ  pháº©m cháº¥t cáº§n ___ trong thi cá»­ vÃ  há»c táº­p.", "answers": ["cÃ³", "cáº§n cÃ³"]}, {"q": "Há»c sinh cáº§n biáº¿t ___ trá»ng Ã½ kiáº¿n cá»§a ngÆ°á»i khÃ¡c.", "answers": ["tÃ´n", "tÃ´n trá»ng"]}, {"q": "Viá»‡c láº¡m dá»¥ng máº¡ng xÃ£ há»™i cÃ³ thá»ƒ gÃ¢y ra nhiá»u ___ quáº£ tiÃªu cá»±c.", "answers": ["háº­u", "háº­u quáº£"]}, {"q": "Má»—i ngÆ°á»i cáº§n cÃ³ thÃ¡i Ä‘á»™ sá»‘ng ___ quan trÆ°á»›c nhá»¯ng khÃ³ khÄƒn.", "answers": ["láº¡c", "láº¡c quan"]}, {"q": "Tinh tháº§n Ä‘oÃ n ___ lÃ  sá»©c máº¡nh cá»§a táº­p thá»ƒ.", "answers": ["káº¿t", "Ä‘oÃ n káº¿t"]}, {"q": "Lá»‘i sá»‘ng thiáº¿u ___ nhiá»‡m sáº½ gÃ¢y nhiá»u há»‡ lá»¥y.", "answers": ["trÃ¡ch", "trÃ¡ch nhiá»‡m"]}, {"q": "Kiáº¿n thá»©c lÃ  hÃ nh trang ___ thiáº¿t cho tÆ°Æ¡ng lai.", "answers": ["cáº§n", "cáº§n thiáº¿t"]}, {"q": "Há»c sinh cáº§n rÃ¨n luyá»‡n kháº£ nÄƒng ___ duy pháº£n biá»‡n.", "answers": ["tÆ°", "tÆ° duy"]}, {"q": "Viá»‡c xÃ¡c Ä‘á»‹nh má»¥c tiÃªu rÃµ rÃ ng sáº½ táº¡o Ä‘á»™ng ___ há»c táº­p.", "answers": ["lá»±c", "Ä‘á»™ng lá»±c"]}, {"q": "Tháº§y cÃ´ luÃ´n lÃ  ngÆ°á»i ___ dáº¯t há»c sinh trÃªn con Ä‘Æ°á»ng tri thá»©c.", "answers": ["dáº«n", "dáº«n dáº¯t"]}, {"q": "ThÃ nh cÃ´ng Ä‘Ã²i há»i quÃ¡ trÃ¬nh ná»— lá»±c lÃ¢u ___, bá»n bá»‰.", "answers": ["dÃ i", "lÃ¢u dÃ i"]}, {"q": "Há»c sinh khÃ´ng nÃªn cÃ³ thÃ¡i Ä‘á»™ ___ á»· láº¡i vÃ o ngÆ°á»i khÃ¡c.", "answers": ["thá»¥", "thá»¥ Ä‘á»™ng"]}, {"q": "Viá»‡c Ä‘á»c sÃ¡ch giÃºp má»Ÿ ___ táº§m hiá»ƒu biáº¿t.", "answers": ["rá»™ng", "má»Ÿ rá»™ng"]}, {"q": "MÃ´i trÆ°á»ng há»c Ä‘Æ°á»ng cáº§n Ä‘Æ°á»£c xÃ¢y dá»±ng lÃ nh ___ vÃ  an toÃ n.", "answers": ["máº¡nh", "lÃ nh máº¡nh"]}, {"q": "Tuá»•i tráº» cáº§n sá»‘ng cÃ³ Æ°á»›c mÆ¡ vÃ  ___ vá»ng.", "answers": ["hoÃ i", "hoÃ i vá»ng"]}, {"q": "Sá»± khÃ¡c biá»‡t cáº§n Ä‘Æ°á»£c ___ trá»ng trong xÃ£ há»™i hiá»‡n Ä‘áº¡i.", "answers": ["tÃ´n", "tÃ´n trá»ng"]}, {"q": "GiÃ¡o dá»¥c Ä‘Ã³ng vai trÃ² then ___ trong sá»± phÃ¡t triá»ƒn con ngÆ°á»i.", "answers": ["chá»‘t", "then chá»‘t"]}, {"q": "Há»c sinh cáº§n chá»§ Ä‘á»™ng ___ thu kiáº¿n thá»©c má»›i.", "answers": ["tiáº¿p", "tiáº¿p thu"]}, {"q": "Quáº£n lÃ­ thá»i gian há»£p lÃ­ giÃºp nÃ¢ng cao hiá»‡u ___ há»c táº­p.", "answers": ["quáº£", "hiá»‡u quáº£"]}, {"q": "ThÃ¡i Ä‘á»™ há»c táº­p nghiÃªm tÃºc lÃ  yáº¿u tá»‘ ___ Ä‘á»‹nh káº¿t quáº£.", "answers": ["quyáº¿t", "quyáº¿t Ä‘á»‹nh"]}, {"q": "Má»—i cÃ¡ nhÃ¢n cáº§n cÃ³ Ã½ thá»©c báº£o vá»‡ mÃ´i trÆ°á»ng sá»‘ng xung ___.", "answers": ["quanh", "xung quanh"]}, {"q": "Sá»± kiÃªn trÃ¬ lÃ  chÃ¬a khÃ³a dáº«n Ä‘áº¿n thÃ nh ___.", "answers": ["cÃ´ng", "thÃ nh cÃ´ng"]}, {"q": "Tuá»•i tráº» cáº§n xÃ¡c Ä‘á»‹nh rÃµ ___ sá»‘ng Ä‘á»ƒ Ä‘á»‹nh hÆ°á»›ng tÆ°Æ¡ng lai.", "answers": ["lÃ½ tÆ°á»Ÿng"]}],
  }
};

const STORAGE_KEY = "giai_cuu_tieng_viet_v1";
const defaultState = () => ({
  score: 0,
  badges: [],
  done: Object.fromEntries(CONFIG.stations.map((s,i)=>[s.id,false])),
  unlocked: Object.fromEntries(CONFIG.stations.map((s,i)=>[s.id, i===0])),
  voiceGender: "male",
});
let state = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    const parsed = JSON.parse(raw);
    const d = defaultState();
    return {
      ...d,
      ...parsed,
      done: { ...d.done, ...(parsed.done||{}) },
      unlocked: { ...d.unlocked, ...(parsed.unlocked||{}) },
    };
  }catch{ return defaultState(); }
}
function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }catch{} }
function resetState(){ state = defaultState(); saveState(); updateHUD(); renderMap(); showScreen("map"); }

const scoreEl = document.getElementById("score");
const badgesCountEl = document.getElementById("badgesCount");
const ttsState = document.getElementById("ttsState");
const homeBtn = document.getElementById("homeBtn");

function updateHUD(){
  scoreEl.textContent = String(state.score||0);
  badgesCountEl.textContent = String((state.badges||[]).length);
  document.getElementById("appTitle").textContent = CONFIG.title;
  document.getElementById("appSubtitle").textContent = CONFIG.subtitle;
}
function showScreen(which){
  const map = document.getElementById("screenMap");
  const station = document.getElementById("screenStation");
  if(which==="map"){ map.classList.remove("hide"); station.classList.add("hide"); homeBtn.disabled=true; }
  else{ map.classList.add("hide"); station.classList.remove("hide"); homeBtn.disabled=false; }
}

let voices = [];
let currentVoice = null;
function loadVoices(){ try{ voices = window.speechSynthesis.getVoices() || []; }catch{ voices=[]; } pickByGender(state.voiceGender||"male"); }
function pickByGender(gender){
  state.voiceGender = gender;
  const vi = voices.filter(v => /vi|vietnam/i.test(v.lang||v.name));
  const list = vi.length ? vi : voices;
  const want = gender==="male" ? /(male|nam|man)/i : /(female|nu|woman)/i;
  currentVoice = list.find(v=> want.test(v.name)) || list[0] || null;
  saveState();
}
function speak(text){
  try{
    const synth = window.speechSynthesis; if(!synth) return;
    try{ synth.cancel(); }catch{}
    const u = new SpeechSynthesisUtterance(text);
    u.lang = CONFIG.lang;
    if(currentVoice) u.voice = currentVoice;
    u.rate = 0.95; u.volume = 1;
    u.onstart = ()=> ttsState.textContent = "Äang phÃ¡t...";
    u.onend = ()=> ttsState.textContent = "Sáºµn sÃ ng";
    u.onerror = ()=> ttsState.textContent = "Sáºµn sÃ ng";
    synth.speak(u);
  }catch{}
}

function speakSequence(parts){
  try{
    const synth = window.speechSynthesis; if(!synth) return;
    try{ synth.cancel(); }catch{}
    const arr = (parts||[]).map(x=>String(x||"").trim()).filter(Boolean);
    if(arr.length===0) return;
    let i = 0;
    const sayNext = ()=>{
      const u = new SpeechSynthesisUtterance(arr[i]);
      u.lang = CONFIG.lang;
      if(currentVoice) u.voice = currentVoice;
      u.rate = 0.95; u.volume = 1;
      u.onstart = ()=> ttsState.textContent = "Äang phÃ¡t...";
      u.onend = ()=>{
        i++;
        if(i < arr.length) sayNext();
        else ttsState.textContent = "Sáºµn sÃ ng";
      };
      u.onerror = ()=>{
        i++;
        if(i < arr.length) sayNext();
        else ttsState.textContent = "Sáºµn sÃ ng";
      };
      synth.speak(u);
    };
    sayNext();
  }catch{}
}

if (window.speechSynthesis && "onvoiceschanged" in window.speechSynthesis) {
  window.speechSynthesis.onvoiceschanged = loadVoices;
}
setTimeout(loadVoices, 200);
setTimeout(loadVoices, 800);

function renderMap(){
  const wrap = document.getElementById("mapStations");
  wrap.innerHTML = "";
  CONFIG.stations.forEach((s)=>{
    const div = document.createElement("div");
    div.className = "station" + (state.unlocked[s.id] ? "" : " disabled");
    const btn = document.createElement("button");
    btn.className = "btn btn-emerald";
    btn.textContent = state.done[s.id] ? "âœ… ÄÃ£ xong" : "VÃ o tráº¡m";
    btn.disabled = !state.unlocked[s.id];
    btn.addEventListener("click", ()=> startStation(s.id));
    div.innerHTML = `<div class="title">${s.icon} ${s.name}</div><div class="hint">${s.desc}</div>`;
    div.appendChild(btn);
    wrap.appendChild(div);
  });
}

let currentStation = null;
let round = 0;
let right = 0;

function stationHeader(){
  return `
    <div class="hint">LÆ°á»£t <b>${round+1}</b>/30 â€¢ ÄÃºng: <b>${right}</b></div>
    <div class="divider"></div>
  `;
}
function givePoints(p){ state.score=(state.score||0)+p; saveState(); updateHUD(); }
function finishStation(){
  if(!state.done[currentStation.id]){
    state.done[currentStation.id] = true;
    state.badges.push(`ÄÃ£ qua ${currentStation.name}`);
    const idx = CONFIG.stations.findIndex(x=>x.id===currentStation.id);
    const next = CONFIG.stations[idx+1];
    if(next) state.unlocked[next.id] = true;
    saveState();
  }
  updateHUD(); renderMap(); showScreen("map");
}
function startStation(id){
  currentStation = CONFIG.stations.find(s=>s.id===id);
  round = 0; right = 0;
  document.getElementById("stationTitle").textContent = `${currentStation.icon} ${currentStation.name} â€” ${currentStation.desc}`;
  showScreen("station");
  renderRound();
}

function norm(s){ return (s||"").trim().replace(/\s+/g," ").toLowerCase(); }

function renderRound(){
  const card = document.getElementById("stationCard");
  if(currentStation.type==="mcq") return renderMCQ(card);
  if(currentStation.type==="fill") return renderFill(card);
}

function renderMCQ(card){
  const bank = CONFIG.banks[currentStation.id] || [];
  const item = bank[round % bank.length];
  const isPronounceStation = currentStation.id === "amchuan";

  const choices = (item.choices||[]).map(c=>{
    const esc = String(c).replace(/"/g,'&quot;');
    if(isPronounceStation){
      return `
        <div class="row" style="justify-content:flex-start;gap:6px">
          <button class="btn btn-emerald-ghost playWord" data-w="${esc}" title="Nghe phÃ¡t Ã¢m">ğŸ”Š</button>
          <button class="btn btn-emerald-ghost mcqBtn" data-c="${esc}">${c}</button>
        </div>
      `;
    }
    return `<button class="btn btn-emerald-ghost mcqBtn" data-c="${esc}">${c}</button>`;
  }).join("");

  card.innerHTML = stationHeader() + `
    <div class="big">${item.q}</div>
    ${isPronounceStation ? `<div class="hint">Báº¥m ğŸ”Š Ä‘á»ƒ nghe phÃ¡t Ã¢m tá»«ng tá»«, rá»“i chá»n tá»« Ä‘Ãºng.</div>` : ``}
    <div class="row" style="justify-content:flex-start;gap:8px;margin-top:10px;flex-wrap:wrap" id="mcqWrap">${choices}</div>
    <div class="row" style="justify-content:flex-start;gap:8px;margin-top:10px">
      <button class="btn btn-emerald-ghost" id="playQ">${isPronounceStation ? "ğŸ”Š Nghe phÃ¡t Ã¢m" : "ğŸ”Š Nghe cÃ¢u"}</button>
    </div>
    <div id="reveal" class="hide" style="margin-top:10px"></div>
  `;

  // Play question / words
  card.querySelector("#playQ").addEventListener("click", ()=>{
    if(isPronounceStation) speakSequence(item.choices || []);
    else speak(String(item.q||"").replace(/â€¦+/g,""));
  });

  // Individual word pronunciation (station 1)
  card.querySelectorAll(".playWord").forEach(btn=>{
    btn.addEventListener("click", (e)=>{
      e.preventDefault();
      e.stopPropagation();
      const w = btn.getAttribute("data-w") || "";
      speak(w);
    });
  });

  card.querySelectorAll(".mcqBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const c = btn.getAttribute("data-c");
      const ok = (c === item.correct);
      const box = card.querySelector("#reveal");
      box.className = ok ? "win station" : "lose station";
      box.innerHTML = `
        <div>Káº¿t quáº£: ${ok ? "ÄÃºng âœ…" : "Sai âŒ"}</div>
        <div class="hint">ÄÃ¡p Ã¡n: <b>${item.correct}</b></div>
        <div class="row" style="justify-content:flex-start;margin-top:10px;gap:8px">
          <button class="btn btn-gray" id="nextBtn">CÃ¢u tiáº¿p theo</button>
          <button class="btn btn-emerald-ghost" id="homeNow">Vá» báº£n Ä‘á»“</button>
        </div>
      `;
      if(ok){ right++; givePoints(5); }
      box.querySelector("#homeNow").addEventListener("click", finishStation, {once:true});
      box.querySelector("#nextBtn").addEventListener("click", ()=>{
        round++;
        if(round >= 30){ finishStation(); return; }
        renderRound();
      }, {once:true});
    });
  });
}

function renderFill(card){
  const bank = CONFIG.banks[currentStation.id] || [];
  const item = bank[round % bank.length];
  card.innerHTML = stationHeader() + `
    <div class="big">${item.q}</div>
    <div class="hint" style="margin-top:6px">GÃµ tá»«/cá»¥m tá»« thay cho dáº¥u <b>___</b> rá»“i báº¥m â€œKiá»ƒm traâ€.</div>
    <div style="margin-top:10px">
      <input type="text" id="ansInput" placeholder="Nháº­p Ä‘Ã¡p Ã¡n..." autocomplete="off" />
    </div>
    <div class="row" style="justify-content:flex-start;gap:8px;margin-top:10px">
      <button class="btn btn-emerald" id="checkBtn">Kiá»ƒm tra</button>
      <button class="btn btn-emerald-ghost" id="playFill">ğŸ”Š Nghe cÃ¢u</button>
    </div>
    <div id="reveal" class="hide" style="margin-top:10px"></div>
  `;
  card.querySelector("#playFill").addEventListener("click", ()=> speak(item.q.replace("___","...")));
  const input = card.querySelector("#ansInput");
  input.focus();

  function check(){
    const got = norm(input.value);
    const accepts = (item.answers||[]).map(norm);
    const ok = accepts.includes(got);
    const box = card.querySelector("#reveal");
    box.className = ok ? "win station" : "lose station";
    box.innerHTML = `
      <div>Káº¿t quáº£: ${ok ? "ÄÃºng âœ…" : "Sai âŒ"}</div>
      <div class="hint">ÄÃ¡p Ã¡n cháº¥p nháº­n: <b>${(item.answers||[]).join(" / ")}</b></div>
      <div class="row" style="justify-content:flex-start;margin-top:10px;gap:8px">
        <button class="btn btn-gray" id="nextBtn">CÃ¢u tiáº¿p theo</button>
        <button class="btn btn-emerald-ghost" id="homeNow">Vá» báº£n Ä‘á»“</button>
      </div>
    `;
    if(ok){ right++; givePoints(5); }
    box.querySelector("#homeNow").addEventListener("click", finishStation, {once:true});
    box.querySelector("#nextBtn").addEventListener("click", ()=>{
      round++;
      if(round >= 30){ finishStation(); return; }
      renderRound();
    }, {once:true});
  }
  card.querySelector("#checkBtn").addEventListener("click", check);
  input.addEventListener("keydown", (e)=>{ if(e.key==="Enter") check(); });
}

document.getElementById("homeBtn").addEventListener("click", ()=>{ showScreen("map"); renderMap(); });
document.getElementById("resetBtn").addEventListener("click", resetState);
document.getElementById("maleBtn").addEventListener("click", ()=> pickByGender("male"));
document.getElementById("femaleBtn").addEventListener("click", ()=> pickByGender("female"));
document.getElementById("tryVoiceBtn").addEventListener("click", ()=> speak("Xin chÃ o. ChÃºng ta báº¯t Ä‘áº§u giáº£i cá»©u tiáº¿ng Viá»‡t nhÃ©."));
updateHUD(); renderMap(); showScreen("map");
</script>
</body>
</html>
